<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>loading...</title>
    <meta name="color-scheme" content="light dark">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hyrious/github-markdown-css@main/github-markdown.css">
    <link rel="stylesheet" id="__hljs__">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"></script>
    <style>.mermaid { text-align: center; }</style>
</head>
<body class="markdown-body" style="max-width: 70ch; margin: 1em auto; padding: 0 2ch;">
    <script id="__END__" src="https://cdn.jsdelivr.net/npm/marked"></script>
    <script type="module">
        const mermaidLink = document.createElement('script')
        mermaidLink.src = 'https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js'
        const light = "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/github.min.css"
        const dark = "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/github-dark.min.css"
        const themeLink = document.getElementById("__hljs__")
        const darkTheme = matchMedia('(prefers-color-scheme: dark)')
        darkTheme.onchange = ({ matches }) => {
            themeLink.href = matches ? dark : light
        }
        darkTheme.onchange(darkTheme)
        const refreshMermaid = () => {
            Array.from(body.querySelectorAll('.mermaid')).forEach((e, i) => {
                if (!(typeof mermaid < 'u') || e.dataset.processed) return
                mermaid.mermaidAPI.render(`mermaid-${i}`, e.textContent, (svg) => {
                    e.innerHTML = svg
                })
            })
        }
        mermaidLink.onload = () => {
            const { matches } = darkTheme
            mermaid.initialize({ startOnLoad: false, theme: matches ? 'dark' : 'default' })
            refreshMermaid()
        }
        const __END__ = document.getElementById('__END__')
        const source = new EventSource('/__source')
        const template = document.createElement('template')
        const body = document.body
        body.appendChild(mermaidLink)
        marked.setOptions({
            highlight(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext'
                return hljs.highlight(code, { language }).value
            }
        })
        marked.use({
            renderer: {
                listitem(text, task, checked) {
                    if (task) {
                        text = text.replace('type="checkbox">', checked
                            ? 'class="task-list-item-checkbox" type="checkbox" checked>'
                            : 'class="task-list-item-checkbox" type="checkbox">'
                        )
                        return '<li class="task-list-item">' + text + '</li>'
                    }
                    return '<li>' + text + '</li>'
                },
                list(body, ordered, start) {
                    const tag = ordered ? 'ol' : 'ul'
                    const suffix = body.includes('<li class="task-list-item">')
                        ? ' class="contains-task-list">'
                        : '>'
                    return '<' + tag + suffix + body + '</' + tag + '>'
                },
                code(code, lang) {
                    if (lang === 'mermaid') {
                        return '<div class="mermaid">' + code + '</div>'
                    }
                    return false
                },
            }
        })
        let raf = 0
        source.onmessage = ({ data }) => {
            const text = JSON.parse(data)
            template.innerHTML = marked.parse(text)
            const node = template.content.cloneNode(true)
            while (body.firstChild !== __END__) {
                body.removeChild(body.firstChild)
            }
            body.insertBefore(node, __END__)
            cancelAnimationFrame(raf)
            raf = requestAnimationFrame(() => {
                const maybeTitle = document.querySelector('h1, h2')
                document.title = maybeTitle ? maybeTitle.textContent : 'Untitled'
                refreshMermaid()
            })
        }
    </script>
</body>
</html>
